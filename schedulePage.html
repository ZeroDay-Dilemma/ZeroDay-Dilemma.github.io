<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="src/somecss.css">
  <script src="src/someJS.js"></script>
  <script src="src/showDB_Obscured_encoded.json" type="application/json"></script>
  <script src="src/specialEvents.json" type="application/json"></script>
  <title>Schedule</title>
  <link rel="icon" type="image/x-icon" href="/src/logo_225x255.png">
  <style>
    .calendar {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      margin: 20px 0;
      table-layout: fixed;
    }


    @media (max-width: 768px) {
      .calendar {
        width: 100%;
      }

      .showElemDiv h3 {
        font-size: 0.9em !important;
      }

      .showElemDiv p {
        font-size: 0.6em !important;
      }
    }

    .calendar th,
    .calendar td {
      border: 1px solid var(--Light-Gray);
      padding: 8px;
      text-align: center;
    }

    .calendar th {
      background-color: var(--AOK-Teal);
      color: var(--Gold);
      font-weight: bold;
    }

    .calendar td {
      height: 40px;
      position: relative;
    }

    .calendar td.hour-mark {
      background-color: var(--Light-Gray);
      font-weight: bold;
      color: var(--Black);
      width: 80px;
    }

    .current-hour {
      background-color: var(--Gold) !important;
      color: black !important;
    }

    .calendar td.current-hour,
    .calendar td.current-hour p,
    .calendar td.current-hour a {
      color: black !important;
    }

    .calendar td.current-hour h3 {
      color: var(--Red) !important;
    }


    .calendar .show-block {
      background-color: var(--Retriever-Brown);
      color: white;

    }

    .show-cell {
      background-color: var(--AOK-Teal);
    }

    .special-event h3 {
      text-align: center;
      font-size: 1.5em;
      color: white;
      background-color: var(--AOK-Teal);
      padding: 10px;
      border-radius: 10px;
      /* animation: festive 10s infinite alternate; */
    }

    @keyframes festive {
      0% {
        background-color: var(--AOK-Teal);
      }

      100% {
        background-color: var(--Gold);
      }
    }

    .showElemDiv {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      position: absolute;
      padding: 4px;
      padding-left:1px;
      padding-right:1px;
      border-radius: 4px;
      position: absolute;

      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .showElemDiv h3 {
      margin: 0;
      padding: 0;
      text-align: center;
      font-size: 1em;
      color: var(--Gold);
    }

    .showElemDiv p {
      margin: 0;
      padding: 0;
      text-align: center;
      font-size: 0.8em;
      color: white;
    }

    .specialEvent {
      background-color: var(--Dark-Gray);
      color: white;
    }

    .special-event-enabled span{
      /* color: var(--Red); */
      animation: weAreLive 3s infinite alternate;
    }

    
    @keyframes weAreLive {
      0% {
        color: white;
      }
      30% {
        color: white;
      }
      70% {
        color: var(--Red);
      }

      100% {
        color: var(--Red);
      }
    }

    #specialEventTitlebox {
      visibility: hidden;
      /*10 padding all around default
  24 margin top bottom default*/
      padding: 0px;
      margin:0px;
    }

    .special-event-enabled {
      visibility: visible !important;
    }
    .special-event-enabled h3{
      padding: 10px !important;
      margin: 0 24px !important;

    }

    #clickableLive {
      /* make not an obvious link, want whole element to seem clickable */
      visibility: hidden;
      text-decoration: none;
      color: inherit;
    }


    .calendar th:not(:first-child),
    .calendar td:not(:first-child) {
      width: calc((100% - 80px) / 7);
    }
  </style>
</head>

<body>
  <header>
    <div class="logo-circle">
      <img
        src="imgs/wmbc/logo-text-225x255.png"
        alt="University Radio Station Logo">
    </div>
    <h1>WMBC: Weekly Schedule</h1>
  </header>
  <nav class="tabs">
    <ul>
      <li><a href="radio_listener.html">Listen!</a></li>
      <li><a href="schedulePage.html">Schedule</a></li>
      <li><a href="baseDJPage.html">Explore our shows!</a></li>
    </ul>
  </nav>
  <div class="container" style="margin-bottom:20px">
    <a id="clickableLive" class="special-event">
      <h3 class="special-event" id="specialEventTitlebox"></h3>
    </a>

    <table class="calendar">
      <thead>
        <tr>
          <th>Time</th>
          <th>Sunday</th>
          <th>Monday</th>
          <th>Tuesday</th>
          <th>Wednesday</th>
          <th>Thursday</th>
          <th>Friday</th>
          <th>Saturday</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows for each hour from 11:00 AM to 11:00 PM -->
        <tr>
          <td class="hour-mark">11:00 AM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">12:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">1:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">2:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">3:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">4:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">5:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">6:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">7:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">8:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">9:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">10:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class="hour-mark">11:00 PM</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>
  <footer class="footer">
    <p style>WMBC's Web Player, made by will :3</p>
  </footer>

  <script>
    const dayToIndex = {
      "Sunday": 0,
      "Monday": 1,
      "Tuesday": 2,
      "Wednesday": 3,
      "Thursday": 4,
      "Friday": 5,
      "Saturday": 6
    };

    //add function so when its viewed on mobile, the day titles are replaced
    //with abbreviations, and the cells are elongated
    document.addEventListener("DOMContentLoaded", function () {
      const dayTitles = document.querySelectorAll(".calendar thead th");
      const dayCells = document.querySelectorAll(".calendar tbody tr td");
      if (window.innerWidth < 600) {
        dayTitles.forEach((title, i) => {
          if (title.textContent !== "Time") {
            title.textContent = title.textContent.slice(0, 3);
          }
        });
        dayCells.forEach(cell => {
          cell.style.width = "20%";
          //make cells taller
          cell.style.padding = "20px 0";
        });
        //remove sat/sun from the schedule, so first and last child for each row

      }
    });


    function decodeName(encodedName, key) {
      // Decode the Base64 string
      const encodedBytes = Uint8Array.from(atob(encodedName), c => c.charCodeAt(0));

      // Convert key to byte array
      const keyBytes = new TextEncoder().encode(key);

      // XOR each byte of the encoded name with the corresponding byte of the key
      const decodedBytes = encodedBytes.map((byte, i) => byte ^ keyBytes[i % keyBytes.length]);

      // Convert the byte array back to a string
      return new TextDecoder().decode(decodedBytes);
    }

    var DJ_JSON;
    document.addEventListener("DOMContentLoaded", function () {
      //Fetch data
      fetch('./src/showDB_Obscured_encoded.json')
        .then((response) => response.json())
        .then((json) => {
          console.log(json);
          DJ_JSON = json;
          loadSpecialtyShows();
        })
    });

    

    function loadSpecialtyShows() {
      const bkup_DJ = DJ_JSON;
      fetch('./src/specialEvents.json')
        .then((response) => response.json())
        .then((json) => {
          console.log(json);
          //append to existing array of shows
          //remove the first element, which is the header
          if (json.length === 0) {
            console.log("no special events");
            populateSchedule();
            return;
          }
          if (!json[0].hasOwnProperty("eventTitle") || !json[0].hasOwnProperty("eventDescription") || !json[0].hasOwnProperty("runTime")) {
            console.log("incorrectly formatted specialty show list!");
            DJ_JSON = bkup_DJ;
            populateSchedule();
            return;
          }

          const eventInfoJson = json.shift();
          DJ_JSON = DJ_JSON.concat(json);

          console.log(eventInfoJson)
          console.log("passing event title to populate schedule");
          populateSchedule(eventInfoJson)
          return;
        }).catch(error => {
          console.log(error);
          console.log("SHOULD ONLY HIT ON FAILURE");
          console.log("error loading specialty shows");

          DJ_JSON = bkup_DJ;
          populateSchedule();
          return;
          });


          

    }


    // JavaScript to highlight the current hour
    const highlightCurrentHour = () => {
      console.log("highlighting current hour");
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinutes = now.getMinutes();

      //if time is outside of 11am-11pm, return
      if (currentHour < 11 || currentHour > 23) {
        console.log("outside of 11am-11pm");
        return;
      }
      // Convert current time to 12-hour format
      let displayHour = currentHour % 12 || 12;
      const ampm = currentHour >= 12 ? "PM" : "AM";
      const currentTime = `${displayHour}:00 ${ampm}`;
      const currentDay = now.getDay();
      const currentDayName = Object.keys(dayToIndex).find(key => dayToIndex[key] === currentDay);
      // Find the row with the current hour and add the "current-hour" class
      const rows = document.querySelectorAll(".calendar tbody tr");
      rows.forEach(row => {
        const hourCell = row.querySelector(".hour-mark");
        //get the current hour, and the current day of the week
        if (hourCell.textContent === currentTime) {
          hourCell.parentElement.children[currentDay + 1];
          hourCell.parentElement.children[currentDay + 1].classList.add("current-hour");
        }
      });

      //add a check to see if the current hour cell also has the class "show-cell"
      //if so, overwrite the <p> tag to read "Now Playing!"
      //wait until 
      const currentHourCell = document.querySelector(".current-hour");
      if (currentHourCell) {
        console.log("current cell found");
        var classList = currentHourCell.classList
        if (classList.contains("show-cell")) {
          const showElemDiv = currentHourCell.querySelector(".showElemDiv");
          showElemDiv.children[1].innerHTML += `<br> <span style="font-weight:bold; font-size:1em">Now Playing!</span>`;
        }
      }

// FIXME CLEARER WAY TO DO THIS. PUT AT END OF GENERTION SO IT DOESNT BREAK ANYTHING!
      if (window.innerWidth < 600) {
        const rows = document.querySelectorAll(".calendar tbody tr");
        rows.forEach(row => {
          row.children[1].remove();
          row.children[row.children.length - 1].remove();
          
        });
        //remove from calendar header
        const header = document.querySelector(".calendar thead tr");
        header.children[1].remove();
        header.children[header.children.length - 1].remove();

      }
    };
    function loadHostNames(hostNames, DECODE_KEY) {
      //console.log("decrypting....");
      var outputNames = [];
      hostNames.forEach(name => {
        //console.log(name);
        if (name) {
          //console.log(name, "todo");
          var crackedName = decodeName(name, DECODE_KEY);
          //console.log(crackedName, "todo");
          outputNames.push(crackedName);
        }
      });
      return outputNames;
    }

    function isEventLive(eventInfoJson) {
      //determine if event is currently running via runTime
      // "runTime": {
      //   "dayOfWeek": "Monday",
      //   "startTime": "12:00",
      //   "durationMinutes": 660
      // } 
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinutes = now.getMinutes();
      const currentDay = now.getDay();
      const currentDayName = Object.keys(dayToIndex).find(key => dayToIndex[key] === currentDay);
      const currentTime = `${currentHour}:${currentMinutes}`;
      console.log(eventInfoJson.runTime);
      const runDay = eventInfoJson.runTime.dayOfWeek;
      const runHour = eventInfoJson.runTime.startTime.split(":")[0];
      const runMinutes = eventInfoJson.runTime.startTime.split(":")[1];
      const runDuration = eventInfoJson.runTime.durationMinutes;
      // need to match day to current day and schedule time to current time
      if (runDay === currentDayName) { //same day
        //show ends at start hour + runDuration%60 (its in minutes), then also then round the remainder to 15/30/45/00 minutes
        const endHour = (parseInt(runHour) + Math.floor(runDuration / 60)) % 24;
        const endMinutes = (parseInt(runMinutes) + runDuration % 60) % 60;
        console.log("end time: ", endHour, ":", endMinutes);
        console.log(currentHour , " >=? ", parseInt(runHour), " && ", currentHour, " <? ", (parseInt(endHour)));
        if(currentHour >= parseInt(runHour) && currentHour < endHour) {
          console.log("event is live!");
          return true;
        }
      }
      console.log("event is not live");
      return false;

    }
    function populateSchedule(eventInfoJson = { eventTitle: "!NOEVENT", eventDescription: "", runTimeStr: "", runTime: "" }) {


      if (eventInfoJson.eventTitle !== "!NOEVENT") {
        console.log(eventInfoJson);
        console.log("handling a special event!");
        const specialEventTitle = document.getElementById("specialEventTitlebox");
        const specialEventLink = document.getElementById("clickableLive");
        let eventDisplayTitle = eventInfoJson.eventTitle + " " + eventInfoJson.runTimeStr + "! ";


        const isLiveBool = isEventLive(eventInfoJson);
        specialEventTitle.innerHTML = eventDisplayTitle + `<span id="isLiveDot" style="color=var(--Red)">${isLiveBool ? "●LIVE" : ""}</span>`;
        if (isLiveBool) {
          specialEventLink.href = "radio_listener.html";
        }
        specialEventLink.classList.add("special-event-enabled");
        specialEventTitle.classList.add("special-event-enabled");

      }
      else {
        console.log("no special event");
        console.log("moving on....");
      }

      const DECODE_KEY = "IHEARTWILLTOLEDO!!!!";
      const schedule = DJ_JSON;
      const rows = document.querySelectorAll(".calendar tbody tr");
      for (let i = 0; i < schedule.length; i++) {
        const show = schedule[i];
        const dayIndex = dayToIndex[show.broadcastTime.dayOfWeek];
        //console.log(dayIndex);
        const startTime = show.broadcastTime.startTime.split(":")[0];
        //console.log(startTime);
        const duration = show.broadcastTime.durationMinutes;
        //console.log(duration);
        //duration is minutes, start time in 24 hour format
        const isHour = (duration === 60) ? true : false;
        //console.log(isHour);
        const endTime = (parseInt(startTime) + (isHour ? 1 : 0)) % 24;
        //console.log(endTime);
        let showName = show.showName;
        //console.log(showName);
        if (showName === "Ebbs %26 Flows") {
          showName = "Ebbs & Flows";
          console.log("jenny handled");
        }
        else if (showName === "Ranting %26 Raving") {
          showName = "Ranting & Raving";
          console.log("other person handled");
        }
        const encryptedHostNames = show.hostNames;
        //console.log(encryptedHostNames);
        const standardShow = show.standardShow;
        //if special show, do not decrypt
        var hostNames = "";
        if (standardShow) {
          hostNames = loadHostNames(encryptedHostNames, DECODE_KEY);
        }
        else {
          hostNames = encryptedHostNames;
        }

        //console.log(hostNames);
        const showBlurb = show.showBlurb;
        //console.log(showBlurb);
        const image = show.image;

        //console.log(standardShow);
        //const previousPlaylists = show.previousPlaylists;
        const row = rows[startTime - 11];
        const cell = row.children[dayIndex + 1];
        const showElement = document.createElement("div");
        //check if already has a show
        //if so, check if new show is special
        //if so, overwrite

        if (cell.children.length > 0) {
          if (standardShow) {
            continue;
          } else {
            cell.innerHTML = "";
          }
        }

        showElement.classList.add("show");
        //make each element clickable and bring you to
        //the show's page, which will be
        // URLbaseDJPage.html?showName=${encodeURIComponent(selectedShowName)}
        showElement.innerHTML = `
        
        <a href="baseDJPage.html?showName=${encodeURIComponent(showName)}">
        <div class="showElemDiv">
          <h3 class="showElem">${showName}</h3>
          <p>${hostNames.join(", ")}</p>
        </div>
        </a>
        `;
        //if special, set class to special
        cell.classList.add("show-cell");

        if (!standardShow) {
          cell.classList += " specialEvent";
          //remove href if special
          showElement.children[0].removeAttribute("href");
        }
        cell.appendChild(showElement);

      }
      highlightCurrentHour();



    }

    // Call the function to highlight the current hour
  </script>
</body>

</html>